import time
import random
from aiogram import Bot
from datetime import datetime, timedelta
from typing import Optional
import os

from rq import Queue
from redis import Redis

from bot.config import settings
from bot.services.db import Db
from bot.services.order_service import OrderService
from bot.services.payment_service import PaymentService
from bot.services.gpt_service import GPTService
from bot.services.progress_messages import PROGRESS_MESSAGES
from bot.models.dto import OrderDTO
from bot.keyboards.main_menu import main_menu

from bot.services.yookassa_service import YooKassaService
from worker.telegram import edit_message

# üìå Telegram Bot –¥–ª—è worker-–∞
bot = Bot(token=os.getenv("BOT_TOKEN"))


# =====================================================================
# 1) WAIT FOR PAYMENT (polling YooKassa)
# =====================================================================


def wait_for_payment(payment_id: Optional[str], order_id: int, chat_id: int):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –û–î–ò–ù —Ä–∞–∑.
    –ï—Å–ª–∏ –ø–ª–∞—Ç—ë–∂ –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî –ø–µ—Ä–µenqueue —Å–µ–±—è –ø–æ–∑–∂–µ.
    –ù–∏–∫–∞–∫–∏—Ö while / sleep.
    """

    CHECK_DELAY_SECONDS = int(os.getenv("PAYMENT_CHECK_DELAY", 30))  # —Ä–∞–∑ –≤ 30 —Å–µ–∫
    MAX_WAIT_SECONDS = int(os.getenv("PAYMENT_TIMEOUT", 60 * 60))  # 30 –º–∏–Ω—É—Ç

    db = Db()
    orders = OrderService(db)
    payments = PaymentService(db)
    yk = YooKassaService()

    ui_message_id = orders.get_ui_message_id(order_id)

    redis_conn = Redis(
        host=os.getenv("REDIS_HOST"),
        port=int(os.getenv("REDIS_PORT", 6379)),
    )

    payments_queue = Queue("payments", connection=redis_conn)
    calculations_queue = Queue("calculations", connection=redis_conn)

    # ======================================================
    # üõ°Ô∏è ADMIN MODE ‚Äî —Å—Ä–∞–∑—É –≤ —Ä–∞—Å—á—ë—Ç
    # ======================================================
    if chat_id in settings.ADMIN_TG_IDS:
        orders.update_status(order_id, "processing")

        edit_message(chat_id, ui_message_id, "üí∞ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞!\n"
                                             "–ù–∞—á–∏–Ω–∞—é –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç ‚ú®")

        calculations_queue.enqueue(
            full_calculation,
            order_id,
            chat_id,
        )
        return

    # ======================================================
    # üë§ –ù–µ—Ç payment_id ‚Äî –æ—à–∏–±–∫–∞
    # ======================================================
    if not payment_id:
        orders.update_status(order_id, "failed")
        edit_message(chat_id, ui_message_id, "‚ùå –û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return

    # ======================================================
    # ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞ –æ–∂–∏–¥–∞–Ω–∏—è
    # ======================================================
    payment = payments.get(payment_id)

    if payment is None:
        orders.update_status(order_id, "failed")
        edit_message(chat_id, ui_message_id, "‚ùå –ü–ª–∞—Ç—ë–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω.")

        return

    created_at = payment["created_at"]
    if isinstance(created_at, str):
        created_at = datetime.fromisoformat(created_at)

    if datetime.utcnow() - created_at > timedelta(seconds=MAX_WAIT_SECONDS):
        orders.update_status(order_id, "expired")

        edit_message(chat_id, ui_message_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑ –∑–∞–Ω–æ–≤–æ.")

        return

    # ======================================================
    # üí≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å YooKassa
    # ======================================================
    try:
        status = yk.get_payment_status(payment_id)
    except Exception:
        payments_queue.enqueue_in(
            timedelta(seconds=CHECK_DELAY_SECONDS),
            wait_for_payment,
            payment_id,
            order_id,
            chat_id,
        )
        return

    payments.update_status(payment_id, status)

    # ======================================================
    # ‚úÖ –ü–ª–∞—Ç—ë–∂ —É—Å–ø–µ—à–µ–Ω ‚Üí —Ä–∞—Å—á—ë—Ç
    # ======================================================
    if status == "succeeded":
        orders.update_status(order_id, "processing")

        edit_message(chat_id, ui_message_id, "üí∞ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞!\n"
                                             "–ù–∞—á–∏–Ω–∞—é –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç ‚ú®")

        ui_message_id = orders.get_ui_message_id(order_id)
        edit_message(chat_id, ui_message_id, "üí∞ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞!\n\n"
                                             "üîÆ –ù–∞—á–∏–Ω–∞—é –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç‚Ä¶")

        calculations_queue.enqueue(
            full_calculation,
            order_id,
            chat_id,
        )
        return

    # ======================================================
    # ‚ùå –ü–ª–∞—Ç—ë–∂ –æ—Ç–º–µ–Ω—ë–Ω
    # ======================================================
    if status in ("canceled", "refunded"):
        orders.update_status(order_id, "failed")

        edit_message(chat_id, ui_message_id, "‚ùå –ü–ª–∞—Ç—ë–∂ –æ—Ç–º–µ–Ω—ë–Ω –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â—ë–Ω.\n"
                                             "–ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞ ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")
        return

    # ======================================================
    # üîÑ –í—Å—ë –µ—â—ë pending ‚Üí –ø—Ä–æ–≤–µ—Ä–∏–º –ø–æ–∑–∂–µ
    # ======================================================
    payments_queue.enqueue_in(
        timedelta(seconds=CHECK_DELAY_SECONDS),
        wait_for_payment,
        payment_id,
        order_id,
        chat_id,
    )


# =====================================================================
# 2) FULL CALCULATION (progress ‚Üí delay ‚Üí GPT ‚Üí result)
# =====================================================================

def full_calculation(order_id: int, chat_id: int):
    from worker.telegram import edit_message

    db = Db()
    orders = OrderService(db)
    gpt = GPTService()

    ui_message_id = orders.get_ui_message_id(order_id)

    order_row = db.fetch_one(
        "SELECT * FROM orders WHERE id=%s",
        (order_id,)
    )
    order = OrderDTO(**order_row)

    item = db.fetch_one(
        "SELECT * FROM order_items WHERE order_id=%s",
        (order_id,)
    )

    birth_date = item["birth_date"]
    birth_time = item["birth_time"]
    birth_city = item["birth_city"]
    extra = item["extra_data"]

    prompt_html = f"–í–ê–ñ–ù–û:\n"
    f"–¢—ã –û–ë–Ø–ó–ê–ù –≤–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –≤ HTML –¥–ª—è Telegram.)\n"
    f"–ü—Ä–∞–≤–∏–ª–∞:\n"
    f"- –î–µ–ª–∞–π –æ—Ç—á–µ—Ç –∫—Ä–∞—Å–∏–≤—ã–º\n"
    f"- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏\n"
    f"- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ç–µ–≥–∏: <b>, <i>, <u>, <code>, <pre>, <a>\n"
    f"- –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –¥–µ–ª–∞–π —á–µ—Ä–µ–∑ \"\n\" \n"
    f"- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown\n"
    f"- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏ <ul>/<li>. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –¥–µ–ª–∞–π –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–π –≤ –Ω–∞—á–∞–ª–æ \"-\"\n"
    f"- –†–∞–∑–¥–µ–ª—è–π –±–ª–æ–∫–∏ —á–µ—Ä–µ–∑ \"\n\n\"\n"
    f"- –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ä–∞–∑—É –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram —Å parse_mode=HTML"

    prompt_end = f"–¢—ã —Å–æ–∑–¥–∞—ë—à—å –ó–ê–í–ï–†–®–Å–ù–ù–´–ô –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.\n"
    f"–í–ê–ñ–ù–û:\n"
    f"- –ù–ï –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å–æ–≤\n"
    f"- –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥\n"
    f"- –ù–ï –ø–∏—à–∏ —Ñ—Ä–∞–∑—ã –≤–∏–¥–∞: '–µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ', '–º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å', '–ø—Ä–µ–¥–ª–∞–≥–∞—é', '—Å–∫–∞–∂–∏—Ç–µ'\n"
    f"- –ù–ï —É–ø–æ–º–∏–Ω–∞–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏, —Ä–∞—Å—á—ë—Ç—ã –∏–ª–∏ –∞–ø—Å–µ–ª–ª—ã\n"
    f"- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —á–∏—Ç–∞—Ç–µ–ª—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–∏–∞–ª–æ–≥–∞\n"
    f"–û—Ç—á—ë—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –£–¢–í–ï–†–ñ–î–ï–ù–ò–Ø–ú–ò –∏ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø–ú–ò, –∞ –Ω–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.\n"
    f"{prompt_html}"

    if order.type == "natal":
        prompt = f"""
        –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥ –º–∏—Ä–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è.
        –¢—ã —Å–æ–∑–¥–∞—ë—à—å –ó–ê–í–ï–†–®–Å–ù–ù–´–ô, –ü–û–õ–ù–´–ô –∏ –°–ê–ú–û–°–¢–û–Ø–¢–ï–õ–¨–ù–´–ô –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç.

        –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
        –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {birth_date}
        –í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è: {birth_time}
        –ì–æ—Ä–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è: {birth_city}

        –ó–∞–¥–∞—á–∞:
        –°–æ–∑–¥–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω—É—é –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é.

        –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–∞—Å–∫—Ä–æ–π:
        - –û–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É –ª–∏—á–Ω–æ—Å—Ç–∏ –∏ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ –≤–µ–∫—Ç–æ—Ä–∞
        - –°–∏–ª—å–Ω—ã–µ –∏ —É—è–∑–≤–∏–º—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞
        - –ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–æ—Ç–∏–≤–∞—Ü–∏–∏
        - –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –≤ –∫–∞—Ä—å–µ—Ä–µ, —Ñ–∏–Ω–∞–Ω—Å–∞—Ö, —Å–∞–º–æ—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
        - –û—Ç–Ω–æ—à–µ–Ω–∏—è, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏, —Å—Ç–∏–ª—å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏
        - –¢–æ—á–∫–∏ —Ä–æ—Å—Ç–∞, –∑–∞–¥–∞—á–∏ –¥—É—à–∏ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è
        - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏

        –§–æ—Ä–º–∞—Ç:
        - –¶–µ–ª—å–Ω—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        - –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        - –ë–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤
        - –ë–µ–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        - –ë–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞—Å—á—ë—Ç–æ–≤ –∏–ª–∏ —É—Å–ª—É–≥
        - –ë–µ–∑ –¥–∏–∞–ª–æ–≥–∞ —Å —á–∏—Ç–∞—Ç–µ–ª–µ–º
        
        –ø—Ä–∏–º–µ—Ä:
        –ù–∏–∂–µ ‚Äî –≥–ª—É–±–æ–∫–∏–π, –Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–π —Ä–∞–∑–±–æ—Ä —Ç–≤–æ–µ–π –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã –≤ —Å—Ç–∏–ª–µ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏. –Ø –±–µ—Ä—É –≤ —Ä–∞—Å—á—ë—Ç –æ–±—â—É—é –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è 26.02.1977, 22:25, –≥. –ë—Ä–∞—Ç—Å–∫ (UTC+8).

–≠—Ç–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞, –∑–∞–¥–∞—á, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –¥–∏–Ω–∞–º–∏–∫, –∞ –Ω–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Å—É–¥—å–±—ã.

üåü 1. –û—Å–Ω–æ–≤–Ω–∞—è —Å—É—Ç—å –ª–∏—á–Ω–æ—Å—Ç–∏: –°–æ–ª–Ω—Ü–µ –≤ –†—ã–±–∞—Ö, –õ—É–Ω–∞ –≤‚Ä¶ (—Å–º. –Ω–∏–∂–µ), –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç ‚Äî –û–≤–µ–Ω / –¢–µ–ª–µ—Ü (—Ç–æ—á–∫–∞ –º–µ–∂–¥—É –∑–Ω–∞–∫–∞–º–∏)

–î–ª—è –¥–∞–Ω–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–∏ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ê—Å—Ü–µ–Ω–¥–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≥—Ä–∞–¥—É—Å—ã –û–≤–Ω–∞ –∏–ª–∏ –ø–µ—Ä–≤—ã–µ –≥—Ä–∞–¥—É—Å—ã –¢–µ–ª—å—Ü–∞ ‚Äî —ç—Ç–æ —Ç–∏–ø–∏—á–Ω–∞—è –ø–æ–≥—Ä–∞–Ω–∏—á–Ω–∞—è –∑–æ–Ω–∞.
–ü–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∫–∞—Ä—Ç–∏–Ω–µ –ª–∏—á–Ω–æ—Å—Ç–∏ –æ—â—É—â–∞–µ—Ç—Å—è —Å–∏–ª—å–Ω–∞—è —Å–º–µ—Å—å: –º—è–≥–∫–æ—Å—Ç—å –∏ –≥–ª—É–±–∏–Ω–∞ –†—ã–± + —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –û–≤–Ω–∞ / —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –¢–µ–ª—å—Ü–∞.

–Ø –æ–ø–∏—à—É –æ–±–µ —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ:

üî• –ï—Å–ª–∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç—Å—è –û–≤–µ–Ω:

‚Äî –≤–Ω–µ—à–Ω–µ —Ç—ã –ø—Ä—è–º–æ–π, –±—ã—Å—Ç—Ä—ã–π, –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–Ω—ã–π
‚Äî –æ—â—É—â–µ–Ω–∏–µ ¬´—è —Å–∞–º —Å–ø—Ä–∞–≤–ª—é—Å—å¬ª
‚Äî —Å–∏–ª—å–Ω–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –∏ –ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å
‚Äî –Ω–µ—Ç–µ—Ä–ø–∏–º–æ—Å—Ç—å –∫ –ø–∞—Å—Å–∏–≤–Ω–æ—Å—Ç–∏ –∏ –Ω–µ–∏—Å–∫—Ä–µ–Ω–Ω–æ—Å—Ç–∏

üå± –ï—Å–ª–∏ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –¢–µ–ª–µ—Ü:

‚Äî –≤–Ω–µ—à–Ω–µ —Å–ø–æ–∫–æ–π–Ω—ã–π, –Ω–∞–¥—ë–∂–Ω—ã–π, —É–≤–µ—Ä–µ–Ω–Ω—ã–π
‚Äî —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, —Ç–µ—Ä–ø–µ–ª–∏–≤–æ—Å—Ç—å, –ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω–æ—Å—Ç—å
‚Äî —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –∫–æ–º—Ñ–æ—Ä—Ç—É, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏, –∫–∞—á–µ—Å—Ç–≤—É
‚Äî —É–º–µ–µ—à—å –¥–æ–≤–æ–¥–∏—Ç—å –¥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ç–æ, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–∞–∂–Ω–æ

üúÅ –ì–ª—É–±–∏–Ω–Ω–∞—è —Å—É—Ç—å (–°–æ–ª–Ω—Ü–µ –≤ –†—ã–±–∞—Ö):

–¢—ã ‚Äî —á–µ–ª–æ–≤–µ–∫ —Ç–æ–Ω–∫–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –º—É–¥—Ä–æ—Å—Ç–∏ –∏ –≤—ã—Å–æ–∫–æ–π –∏–Ω—Ç—É–∏—Ü–∏–∏.
–¢—ã –≤–∏–¥–∏—à—å —Ç–æ, —á—Ç–æ —Å–∫—Ä—ã—Ç–æ, –∏ –æ—â—É—â–∞–µ—à—å –ª—é–¥–µ–π –Ω–∞ —É—Ä–æ–≤–Ω–µ, –≥–¥–µ —Å–ª–æ–≤–∞ —É–∂–µ –Ω–µ –≤–∞–∂–Ω—ã.

–≠—Ç–æ —Å–æ—á–µ—Ç–∞–Ω–∏–µ –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è:

–ø–æ-—Ö–æ—Ä–æ—à–µ–º—É –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º

—Ç–≤–æ—Ä—á–µ—Å–∫–∏–º

–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ —Å–≤–æ–±–æ–¥–Ω—ã–º

–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏ –≥–ª—É–±–æ–∫–∏–º

—É–º–µ—é—â–∏–º –º–µ–Ω—è—Ç—å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –Ω–µ —Å–∏–ª–æ–π, –∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º

üåô 2. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–∏—Ä –∏ —Ä–µ–∞–∫—Ü–∏–∏ (–õ—É–Ω–∞)

–í —ç—Ç—É —ç–ø–æ—Ö—É –∏ –ø—Ä–∏ —ç—Ç–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è –õ—É–Ω–∞ –Ω–∞—Ö–æ–¥–∏–ª–∞—Å—å –≤ –°–∫–æ—Ä–ø–∏–æ–Ω–µ.

–≠—Ç–æ –æ–¥–Ω–∞ –∏–∑ —Å–∞–º—ã—Ö –º–æ—â–Ω—ã—Ö –∏ –≥–ª—É–±–æ–∫–∏—Ö –ª—É–Ω.

‚ú® –ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç:

–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ —á—É–≤—Å—Ç–≤–∞

—Å–∏–ª—å–Ω—É—é –ø–∞–º—è—Ç—å –Ω–∞ —ç–º–æ—Ü–∏–∏

—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å ¬´–≤–∏–¥–µ—Ç—å –ª—é–¥–µ–π –Ω–∞—Å–∫–≤–æ–∑—å¬ª

—É–º–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫—Ä–∏–∑–∏—Å–∞–º–∏

–ø–æ–≤—ã—à–µ–Ω–Ω—É—é –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å

–≤—ã—Å–æ–∫—É—é —Ç–æ—á–∫—É —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏

–¢—ã –Ω–µ –±–æ–∏—à—å—Å—è —Ç—Ä—É–¥–Ω—ã—Ö –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏–π ‚Äî —Ç—ã –∏—Ö –ø–µ—Ä–µ–∂–∏–≥–∞–µ—à—å, –æ–±–Ω–æ–≤–ª—è–µ—à—å—Å—è –∏ –≤—ã—Ö–æ–¥–∏—à—å —Å–∏–ª—å–Ω–µ–µ.

–°–ª–æ–∂–Ω–æ—Å—Ç–∏:

—Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –Ω–µ–¥–æ–≤–µ—Ä–∏—é

–∂–µ–ª–∞–Ω–∏–µ –≤—Å—ë –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å

—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∑–∞–∫—Ä—ã—Ç–æ—Å—Ç—å

–∏–Ω–æ–≥–¥–∞ ‚Äî —Ä–µ–∑–∫–æ—Å—Ç—å, –µ—Å–ª–∏ —Ç–µ–±—è —Ä–∞–Ω–∏–ª–∏

‚òÄÔ∏è 3. –•–∞—Ä–∞–∫—Ç–µ—Ä –∏ –ª–∏—á–Ω–∞—è –º–∏—Å—Å–∏—è
–¢—ã –∑–¥–µ—Å—å, —á—Ç–æ–±—ã:

—Ä–∞—Å–∫—Ä—ã—Ç—å –∏–Ω—Ç—É–∏—Ü–∏—é –∏ —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ –≤–∏–¥–µ–Ω–∏–µ

–Ω–∞—É—á–∏—Ç—å—Å—è –¥–æ–≤–µ—Ä—è—Ç—å –º–∏—Ä—É –∏ –ª—é–¥—è–º

—Å–æ–µ–¥–∏–Ω–∏—Ç—å –¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ—Å—Ç—å

—Å—Ç–∞—Ç—å –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–º –ø–µ—Ä–µ–º–µ–Ω

–≥–ª—É–±–æ–∫–æ –ø–æ–Ω–∏–º–∞—Ç—å –ª—é–¥–µ–π –∏ –ø–æ–º–æ–≥–∞—Ç—å –∏–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å—Å—è

–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:

—ç–º–ø–∞—Ç–∏—è

–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å—Ç–æ–π–∫–æ—Å—Ç—å

—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ —Å–∞–º–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—é

–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –≥–ª—É–±–∏–Ω–∞

—Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ

–∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç

–ª–∏–¥–µ—Ä—Å–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞, –ø—Ä–æ—è–≤–ª—è—é—â–∏–µ—Å—è –Ω–µ –¥–∞–≤–ª–µ–Ω–∏–µ–º, –∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º

–°–ª–∞–±—ã–µ –º–µ—Å—Ç–∞:

—Å–∞–º–æ–∫—Ä–∏—Ç–∏–∫–∞ –∏ —Å–æ–º–Ω–µ–Ω–∏—è

—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∑–∞–∫—Ä—ã—Ç–æ—Å—Ç—å

–∏–Ω–æ–≥–¥–∞ ‚Äî —Ä–µ–∑–∫–∏–µ –≤—Å–ø—ã—à–∫–∏ (–ª—É–Ω–Ω—ã–π –°–∫–æ—Ä–ø–∏–æ–Ω)

—Ç—è–∂–µ–ª–æ –æ—Ç–ø—É—Å–∫–∞—Ç—å –ø—Ä–æ—à–ª–æ–µ

–æ–±–∏–¥–∞, –∫–æ—Ç–æ—Ä–∞—è —Ö—Ä–∞–Ω–∏—Ç—Å—è —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ

üíé 4. –°–∫—Ä—ã—Ç—ã–µ —Ç–∞–ª–∞–Ω—Ç—ã
1) –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ç–∞–ª–∞–Ω—Ç

–¢—ã —Å—á–∏—Ç—ã–≤–∞–µ—à—å –º–æ—Ç–∏–≤—ã –ª—é–¥–µ–π –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ.
–¢—ã —á—É–≤—Å—Ç–≤—É–µ—à—å, –∫–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ –≤—Ä—ë—Ç –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ—Ç.

–≠—Ç–æ –º–æ—â–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç–∞, –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞, –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞.

2) –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª—è—Ç—å —ç–Ω–µ—Ä–≥–∏—è–º–∏

–¢—ã —É–º–µ–µ—à—å –º–µ–Ω—è—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –≤–æ–∫—Ä—É–≥ —Å–µ–±—è: —Å–≤–æ–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º, –≥–æ–ª–æ—Å–æ–º, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–∏–ª–æ–π.

3) –¢–≤–æ—Ä—á–µ—Å–∫–æ–µ –≤–∏–¥–µ–Ω–∏–µ

–£–º–µ–Ω–∏–µ –≤–∏–¥–µ—Ç—å –∫—Ä–∞—Å–∏–≤–æ–µ, –Ω–µ–æ–±—ã—á–Ω–æ–µ, –º–µ—Ç–∞—Ñ–æ—Ä–∏—á–µ—Å–∫–æ–µ.

4) –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π —É–º

–õ—É–Ω–∞ –≤ –°–∫–æ—Ä–ø–∏–æ–Ω–µ –¥–∞—ë—Ç —Ç–∞–ª–∞–Ω—Ç –∫ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é, —Ç–æ—á–Ω–æ–º—É —Ä–∞—Å—á—ë—Ç—É.

‚öñÔ∏è 5. –ö–∞—Ä–º–∏—á–µ—Å–∫–∏–µ —É—Ä–æ–∫–∏
–£—Ä–æ–∫ ‚Ññ1 ‚Äî –¥–æ–≤–µ—Ä–∏–µ

–ü–µ—Ä–µ—Ö–æ–¥ –æ—Ç –Ω–µ–¥–æ–≤–µ—Ä–∏—è, –∫–æ–Ω—Ç—Ä–æ–ª—è –∏ –≤–æ–∑–º–æ–∂–Ω–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –∑–∞–∫—Ä—ã—Ç–æ—Å—Ç–∏ ‚Äî –∫ —É–º–µ–Ω–∏—é –æ—Ç–∫—Ä—ã–≤–∞—Ç—å—Å—è, –Ω–µ –æ–±–µ—Ä–µ–≥–∞—è —Å–µ–±—è –æ—Ç –≤—Å–µ–≥–æ –ø–æ–¥—Ä—è–¥.

–£—Ä–æ–∫ ‚Ññ2 ‚Äî –æ—Ç–ø—É—Å–∫–∞–Ω–∏–µ –ø—Ä–æ—à–ª–æ–≥–æ

–ù–µ —Ç–∞—â–∏—Ç—å —Å—Ç–∞—Ä—É—é –±–æ–ª—å –∏–ª–∏ –≤–∏–Ω—É –∑–∞ —Å–æ–±–æ–π.
–°–∫–æ—Ä–ø–∏–æ–Ω —É—á–∏—Ç ¬´—É–º–∏—Ä–∞—Ç—å –∏ –≤–æ–∑—Ä–æ–∂–¥–∞—Ç—å—Å—è¬ª.

–£—Ä–æ–∫ ‚Ññ3 ‚Äî –ø—Ä–∏–Ω—è—Ç–∏–µ —Å–≤–æ–µ–π —Å–∏–ª—ã

–¢—ã —á–∞—Å—Ç–æ –Ω–µ–¥–æ–æ—Ü–µ–Ω–∏–≤–∞–µ—à—å —Å–≤–æ–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ ‚Äî –∫–∞—Ä–º–∞ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—É—á–∏—Ç—å—Å—è —Å—Ç–æ—è—Ç—å –≤ —Å–∏–ª–µ —Å–ø–æ–∫–æ–π–Ω–æ, –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–∫–∞–∑—ã–≤–∞—Ç—å.

–£—Ä–æ–∫ ‚Ññ4 ‚Äî –±–∞–ª–∞–Ω—Å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –¥—É—Ö–æ–≤–Ω–æ—Å—Ç–∏

–†—ã–±—å—è —ç–Ω–µ—Ä–≥–∏—è –º–æ–∂–µ—Ç ¬´—É–ø–ª—ã–≤–∞—Ç—å¬ª ‚Äî –≤–∞–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å —Å–≤—è–∑—å —Å –∑–µ–º–ª—ë–π.

‚ù§Ô∏è 6. –û—Ç–Ω–æ—à–µ–Ω–∏—è

–¢—ã –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –æ—á–µ–Ω—å –ø—Ä–µ–¥–∞–Ω–Ω—ã–π, –≥–ª—É–±–æ–∫–∏–π, —á–µ—Å—Ç–Ω—ã–π.

–ù–æ:

—Ç–µ–±–µ –Ω—É–∂–Ω–∞ —Ä–µ–∞–ª—å–Ω–∞—è –±–ª–∏–∑–æ—Å—Ç—å, –∞ –Ω–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–µ —Å–≤—è–∑–∏

—Ç—ã —Ç–µ—Ä–ø–µ—Ç—å –Ω–µ –º–æ–∂–µ—à—å –ª–æ–∂—å

–¥–ª—è —Ç–µ–±—è –ª—é–±–æ–≤—å ‚Äî —ç—Ç–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è

—Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –≥–ª—É–±–∂–µ, —á–µ–º –æ–Ω —Å–∞–º —Å–µ–±—è

–¢—ã –≤—ã–±–∏—Ä–∞–µ—à—å —Å–∏–ª—å–Ω—ã—Ö, —É–º–Ω—ã—Ö –∏ —á–µ—Å—Ç–Ω—ã—Ö –ª—é–¥–µ–π.
–ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —Å–ª–∞–± –¥—É—Ö–æ–º ‚Äî —Ç–µ–±–µ —Å –Ω–∏–º –±—ã—Å—Ç—Ä–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–∫—É—á–Ω–æ.

–ö–∞–∫–∞—è –ø–∞—Ä–∞ –∏–¥–µ–∞–ª—å–Ω–∞:

—Ç–æ—Ç, –∫—Ç–æ –Ω–µ –±–æ–∏—Ç—Å—è –≥–ª—É–±–∏–Ω—ã

–∫—Ç–æ —É–º–µ–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å —á–µ—Å—Ç–Ω–æ

–∫—Ç–æ —Ü–µ–Ω–∏—Ç —Ç–≤–æ—é –∏–Ω—Ç—É–∏—Ü–∏—é

–∫—Ç–æ —Å–∞–º —Ä–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è –∏ —Ä–∞—Å—Ç—ë—Ç

üí∞ 7. –î–µ–Ω—å–≥–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å—ã

–í –∫–∞—Ä—Ç–µ –º–Ω–æ–≥–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∏–Ω—Ç—É–∏—Ü–∏–∏ –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª—è—Ç—å —Ä–µ—Å—É—Ä—Å–∞–º–∏.

–£ —Ç–µ–±—è —Ç–∞–ª–∞–Ω—Ç:

—Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è

–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –º–æ–º–µ–Ω—Ç–∞

–ø–æ–Ω–∏–º–∞–Ω–∏—è —Ä–∏—Å–∫–æ–≤

–¥–µ–π—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ –∏–Ω—Å–∞–π—Ç—ã

–î–µ–Ω—å–≥–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç, –∫–æ–≥–¥–∞ —Ç—ã –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è —á–µ–º-—Ç–æ, —á—Ç–æ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª, –≥–ª—É–±–∏–Ω—É, –ª—é–¥—è–º –ø—Ä–∏–Ω–æ—Å–∏—Ç –ø–æ–ª—å–∑—É.

üõ† 8. –ö–∞—Ä—å–µ—Ä–∞ –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–õ—É—á—à–µ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî —Ç–∞–º, –≥–¥–µ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è:

–ø—Å–∏—Ö–æ–ª–æ–≥–∏—è

–∞–Ω–∞–ª–∏—Ç–∏–∫–∞

—Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ

–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

—Ä–∞–±–æ—Ç–∞ —Å –ª—é–¥—å–º–∏

—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏

–ª–∏–¥–µ—Ä—Å—Ç–≤–æ

–¢–µ–±–µ –ø–æ–¥—Ö–æ–¥—è—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏:

–ø—Å–∏—Ö–æ–ª–æ–≥, –∫–æ—É—á, –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫

–ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å

—Å—Ç—Ä–∞—Ç–µ–≥, –∞–Ω–∞–ª–∏—Ç–∏–∫

—Ä–∞–±–æ—Ç–∞ —Å –∫—Ä–∏–∑–∏—Å–∞–º–∏

—Å–æ–∑–¥–∞—Ç–µ–ª—å –ø—Ä–æ–µ–∫—Ç–æ–≤

–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å, —ç–∫—Å–ø–µ—Ä—Ç

—ç–∑–æ—Ç–µ—Ä–∏–∫–∞, –º–µ–¥–∏–∞—Ü–∏—è, –¥—É—Ö–æ–≤–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

–¢—ã –º–æ–∂–µ—à—å –≤–µ—Å—Ç–∏ –ª—é–¥–µ–π –∑–∞ —Å–æ–±–æ–π –º—è–≥–∫–æ, –Ω–æ —Ç–≤—ë—Ä–¥–æ.
–¢—ã —Ö–æ—Ä–æ—à–∏–π —É–ø—Ä–∞–≤–ª–µ–Ω–µ—Ü, –Ω–æ –Ω–µ –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—à—å —Ç—É–ø–æ–π –±—é—Ä–æ–∫—Ä–∞—Ç–∏–∏ ‚Äî –Ω—É–∂–Ω–∞ —Å–≤–æ–±–æ–¥–∞.

üßò‚Äç‚ôÇÔ∏è 9. –ó–¥–æ—Ä–æ–≤—å–µ

–£—è–∑–≤–∏–º—ã–µ –∑–æ–Ω—ã:

—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –≤—ã–≥–æ—Ä–∞–Ω–∏–µ

–Ω–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

–≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

–ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è ‚Üí —Ç–µ–ª–µ—Å–Ω—ã–µ –±–ª–æ–∫–∏

–¢–≤–æ—ë –∑–¥–æ—Ä–æ–≤—å–µ —Å–∏–ª—å–Ω–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç:

—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –≥–∏–≥–∏–µ–Ω—ã

—Å–Ω–∞

–≤–æ–¥—ã

—Å–ø–æ–∫–æ–π–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫

–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:

–π–æ–≥–∞

–≤–æ–¥–∞ (–ø–ª–∞–≤–∞–Ω–∏–µ, –±–∞–Ω–∏, –¥—É—à, —Ä–µ–∫–∏)

–ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–∏—è

–¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏

—Å–ø–æ–∫–æ–π–Ω–∞—è —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞

üîÆ 10. –ò—Ç–æ–≥–æ–≤–æ–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–¢—ã –∑–¥–µ—Å—å, —á—Ç–æ–±—ã —Å—Ç–∞—Ç—å —á–µ–ª–æ–≤–µ–∫–æ–º –≥–ª—É–±–∏–Ω—ã, —Å–∏–ª—ã –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–≤–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –¥—Ä—É–≥–∏–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–≤–æ–∏–º –ø—Ä–∏–º–µ—Ä–æ–º.

–¢—ã —Å–æ–µ–¥–∏–Ω—è–µ—à—å –≤ —Å–µ–±–µ –¥–≤–µ —ç–Ω–µ—Ä–≥–∏–∏:

–†—ã–±—å—é —Ç–æ–Ω–∫–æ—Å—Ç—å –∏ –º—É–¥—Ä–æ—Å—Ç—å

–°–∫–æ—Ä–ø–∏–æ–Ω—å—é —Å–∏–ª—É –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é

–ö–æ–≥–¥–∞ —Ç—ã —Å–ª–µ–¥—É–µ—à—å —Å–≤–æ–µ–º—É –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –∫–æ–º–ø–∞—Å—É ‚Äî —Ç—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ —Å–∏–ª—å–Ω—ã–º –∏ –≤–ª–∏—è—é—â–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º.
        {prompt_end}
        """
    elif order.type == "karma":
        prompt = f"""
        –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥ –º–∏—Ä–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è,
        —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∫–∞—Ä–º–∏—á–µ—Å–∫–æ–π –∏ —ç–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–æ–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏.

        –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
        –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {birth_date}
        –í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è: {birth_time}
        –ì–æ—Ä–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è: {birth_city}

        –ó–∞–¥–∞—á–∞:
        –°–æ–∑–¥–∞–π –ó–ê–í–ï–†–®–Å–ù–ù–´–ô –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç.

        –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–∞—Å–∫—Ä–æ–π:
        - –ö–ª—é—á–µ–≤—ã–µ –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –∏ —É—Ä–æ–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–ø–ª–æ—â–µ–Ω–∏—è
        - –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –ø—Ä–∏—á–∏–Ω—ã –∏—Ö –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è
        - –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
        - –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è
        - –¢–∞–ª–∞–Ω—Ç—ã, –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ –æ–ø—ã—Ç–∞
        - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏ –∫–∞—Ä–º—ã

        –§–æ—Ä–º–∞—Ç:
        - –¶–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç
        - –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        - –ë–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤
        - –ë–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
        - –ë–µ–∑ –¥–∏–∞–ª–æ–≥–∞
        - –ë–µ–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥

        {prompt_end}
        """
    else:
        living_city = extra.get("living_city")
        prompt = f"""
        –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥ –º–∏—Ä–æ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è,
        —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–ª—è—Ä–∞–º –∏ –≥–æ–¥–æ–≤—ã–º —Ü–∏–∫–ª–∞–º.

        –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
        –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {birth_date}
        –í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è: {birth_time}
        –ì–æ—Ä–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è: {birth_city}
        –ì–æ—Ä–æ–¥ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è: {living_city}

        –ó–∞–¥–∞—á–∞:
        –°–æ–∑–¥–∞–π –ó–ê–í–ï–†–®–Å–ù–ù–´–ô —Å–æ–ª—è—Ä–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 2026 –≥–æ–¥.

        –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–∞—Å–∫—Ä–æ–π:
        - –û–±—â—É—é —Ç–µ–º—É –∏ –≤–µ–∫—Ç–æ—Ä –≥–æ–¥–∞
        - –ö–ª—é—á–µ–≤—ã–µ –ø–µ—Ä–∏–æ–¥—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
        - –û—Å–Ω–æ–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        - –ö–∞—Ä—å–µ—Ä—É, –¥–µ–Ω—å–≥–∏ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
        - –û—Ç–Ω–æ—à–µ–Ω–∏—è –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω
        - –†–µ—Å—É—Ä—Å—ã –≥–æ–¥–∞ –∏ –∑–æ–Ω—ã —Ä–∏—Å–∫–∞
        - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞ –≥–æ–¥–∞

        –§–æ—Ä–º–∞—Ç:
        - –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥–æ–¥–æ–≤–æ–π –æ—Ç—á—ë—Ç
        - –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        - –ë–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤
        - –ë–µ–∑ –¥–∏–∞–ª–æ–≥–∞
        - –ë–µ–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞—Å—á—ë—Ç

        {prompt_end}
        """

    edit_message(chat_id, ui_message_id, "‚ú® –ù–∞—á–∏–Ω–∞—é –≥–ª—É–±–æ–∫–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑...")

    # ======================================================
    # üöÄ GPT –í –§–û–ù–ï
    # ======================================================
    from concurrent.futures import ThreadPoolExecutor, Future

    def format_progress(pct: int, line: str) -> str:
        return f"<b>üîÆ –í—ã–ø–æ–ª–Ω—è—é —Ä–∞—Å—á—ë—Ç</b>\n{line}\n\n<b>–ì–æ—Ç–æ–≤–æ:</b> {pct}%"

    def clamp(v: int, lo: int, hi: int) -> int:
        return lo if v < lo else hi if v > hi else v

    with ThreadPoolExecutor(max_workers=1) as executor:
        future: Future[str] = executor.submit(gpt.generate, prompt)

        edit_message(chat_id, ui_message_id, "üîÆ –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω‚Ä¶")

        PROGRESS_INTERVAL = 3
        last_update = 0
        pct = 3
        max_wait_pct = random.randint(92, 97)

        while not future.done():
            now = time.time()
            if now - last_update >= PROGRESS_INTERVAL:
                line = random.choice(PROGRESS_MESSAGES)
                step = random.randint(1, 3)
                pct = clamp(pct + step, 3, max_wait_pct)
                edit_message(chat_id, ui_message_id, format_progress(pct, line))
                last_update = now
            time.sleep(0.25)

        edit_message(chat_id, ui_message_id, "üîÆ –ó–∞–≤–µ—Ä—à–∞—é –∞–Ω–∞–ª–∏–∑‚Ä¶")

        result_text = future.result()

    # ======================================================
    # üíæ –°–û–•–†–ê–ù–ï–ù–ò–ï
    # ======================================================
    orders.save_result(order_id, result_text)
    orders.update_status(order_id, "done")

    from worker.telegram import edit_message, send_message

    edit_message(
        chat_id,
        ui_message_id,
        "üîÆ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω.\n\n"
        "–°–µ–π—á–∞—Å —è –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–æ–±–∏—Ä–∞—é –≤—ã–≤–æ–¥—ã,\n"
        "—Å–æ–ø–æ—Å—Ç–∞–≤–ª—è—é –≤–ª–∏—è–Ω–∏—è –∏ —Ñ–æ—Ä–º–∏—Ä—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.\n\n"
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥."
    )

    time.sleep(3)

    edit_message(
        chat_id,
        ui_message_id,
        "‚ú® –§–∏–Ω–∞–ª—å–Ω—ã–µ —à—Ç—Ä–∏—Ö–∏‚Ä¶\n"
        "–û—Ç—á—ë—Ç –ø–æ—á—Ç–∏ –≥–æ—Ç–æ–≤."
    )

    time.sleep(2)

    chunks = split_html(sanitize_html(result_text))

    for chunk in chunks:
        send_message(chat_id, chunk)
        time.sleep(0.3)

    inline_menu = {
        "inline_keyboard": [
            [
                {"text": "üîÆ –ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞", "callback_data": "action:natal:start"},
            ],
            [
                {"text": "‚ú® –ö–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏", "callback_data": "action:karma:start"},
            ],
            [
                {"text": "üåû –°–æ–ª—è—Ä –Ω–∞ 2026 –≥–æ–¥", "callback_data": "action:solar:start"},
            ],
        ]
    }
    send_message(
        chat_id,
        "‚ú® –Ø –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫.\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å:",
        inline_menu
    )

def split_html(text: str, limit: int = 3500) -> list[str]:
    parts = []
    buffer = ""

    for block in text.split("\n\n"):
        candidate = block if not buffer else buffer + "\n\n" + block

        if len(candidate) <= limit:
            buffer = candidate
        else:
            if buffer:
                parts.append(buffer)
            buffer = block

    if buffer:
        parts.append(buffer)

    return parts

def sanitize_html(text: str) -> str:
    text = text.replace("&", "&amp;")
    text = text.replace("<br/>", "<br>")
    return text